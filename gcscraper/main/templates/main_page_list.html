{% extends 'main_base.html' %}

{% block style %}
    <style>
        input {
            width: auto;
            height: 80%
        }
        input:read-only {
            border:none;
            background-color: transparent;
            color: gray;
        }

        th {
            height: 20px!important;
            padding: 0.1rem !important;
            font-size: 13px;
            background-color: gray!important;
            color: white;
            border-right: white solid 0.5px;
        }
        td {
            /* border: gray solid 1px; */
            cursor: grab;
            vertical-align: middle;
            text-align: center;
            height: 20px!important;
            padding: 0.1rem!important;
            font-size: 10px;
            border-right: white solid 0.5px;
            /* white-space: nowrap!important; */
        }
        td:active {
            cursor: grabbing
        }
        .btn {
            font-size: 10px!important;
        }
        input.checkbox {
            height: 100%;
            width: 100%;
        }
        td a {
            color:blue!important
        }
        input[name=company_code] {
           width: 200px!important;
        }
        
    </style>
{% endblock %}

{% block title %}
ページ一覧
{% endblock %}

{% block content %}
<table class="table">
    <thead>
        <tr>
            <th>コード</th>
            <th>補足</th>
            <th>会社名</th>
            <th>電話番号</th>
            <th>電話可能</th>
            <th>URL</th>
            <th>削除</th>
            <th>追加</th>
        </tr>
      
    </thead>
    <tbody id="sortable">
            {% for page in object_list %}
            <tr id="{{ page.pk }}" class="ui-state-default">
                <td>
                    <input readonly name="code" type="text" value="{{ page.code }}">
                </td>
                <td>
                    <input readonly name="comment" type="text" value="{{ page.comment|default_if_none:'-' }}">
                </td>
                <td>
                    <input readonly name="company_name" type="text" value="{{ page.company_name }}">
                </td>
                <td>
                    <input readonly name="phone_number" type="text" value="{{ page.phone_number }}">
                </td>
                <td>
                    <input type="checkbox" name="is_callable" {% if page.is_callable %} checked="checked" {% endif %}>
                </td>
                <td>
                    <input readonly name="page_url" type="text" value="{{ page.page_url }}">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger delete-row-btn">削除</button>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-success add-row-btn">上に行追加</button>
                </td>
            </tr>
            {% endfor %}
    </tbody>

</table>

{% endblock %}

{% block extra_js %}
    <script>
        //function()
        // function click_action($target) {
        //     alert('click action');
        // }
        // function double_click_action($target) {
        //     $target.attr('readonly', false);
        // }
        function create_empty_data(insert_at) {
            return $.ajax({
                url: "{% url 'main:new_page' %}",
                type: 'POST',
                dataType: 'json',
                async: true,
                data: {
                    insert_at: insert_at
                },
            });
        }
        function delete_page(pk) {
            return $.ajax({
                url: "{% url 'main:delete_page' %}",
                type: 'POST',
                dataType: 'json',
                async: true,
                data: {
                    pk: pk
                },
            });
        }
        function update_page(pk, field_name, field_value) {
            return $.ajax({
                url: "{% url 'main:update_page' %}",
                type: 'POST',
                dataType: 'json',
                async: true,
                data: {
                    pk: pk,
                    field_name : field_name,
                    field_value: field_value
                },
            });
        }
        
       $(function() {
            $( "#sortable" ).sortable({
                update: function(event, ui) {
                    console.log(ui);
                    var updatedInfo =  $('#sortable').sortable("toArray").join(",");
                    console.log(updatedInfo);
                   
                }
            });
            $( "#sortable" ).disableSelection();

            $('.add-row-btn')
            .on('click', function() {
                
            });

           
            $(document)
            .on('dblclick', 'input', function(event) {
                console.log(event.target);
                $(this).attr('readonly', false);
            })
            .on('focusout', 'input', function(event) {
                var $this = $(this);
                var pk = $(this).parent().parent().attr('id');
                var field_name = $(this).attr('name');
                if ($(this).attr('type') == 'checkbox') {
                   
                    var field_value = $(this).prop('checked');
                } else {
                    var field_value = $this.val();
                }
               
                update_page(pk, field_name, field_value)
                .done(function(res) {
                    if (res.error) {
                        alert(res.error);
                        return;
                    } else if (res.success) {
                        $this.attr('readonly', true);
                    } else {
                        alert('else');
                    }
                })
                .fail(function(data, textStatus, xhr) {
                    if (data.status == 401) {
                        window.location.href = BASE_URL_LOGIN;
                    }
                    
                    alert('error');
                });

            })
            .on('click', '.add-row-btn', function(event) {
                var insert_at = $(this).parent().parent().attr('id');
                var $target = $(this).parent().parent();
                create_empty_data(insert_at)
                .done(function(res) {
                    if (res.error) {
                        alert(res.error);
                        return;
                    } else if (res.success) {
                       
                        console.log($(this));
                        var $newly_added = $('<tr>', { class: 'ui-state-default', id: res.pk })
                        .append($('<td>').append($('<input>', { type: 'text', class: 'code', name: 'code'  })))
                        .append($('<td>').append($('<input>', { type: 'text', name: 'comment'  })))
                        .append($('<td>').append($('<input>', { type: 'text', name: 'company_name'  })))
                        .append($('<td>').append($('<input>', { type: 'text', name: 'phone_number'  })))
                        .append($('<td>').append($('<input>', { type: 'checkbox', name: 'is_callable'  })))
                        .append($('<td>').append($('<input>', { type: 'text', name: 'page_url'  })))
                        .append($('<td>').append($('<button>', { type: 'button', class: 'btn btn-sm btn-danger delete-row-btn', text: '削除'})))
                        .append($('<td>').append($('<button>', { type: 'button', class: 'btn btn-sm btn-success add-row-btn', text: '上に行追加'})))
                        .insertBefore($target);
                        $newly_added.find('.code').dblclick();
                    } else {
                        alert('else');
                    }
                })
                .fail(function(data, textStatus, xhr) {
                    if (data.status == 401) {
                        window.location.href = BASE_URL_LOGIN;
                    }
                    
                    alert('error');
                });
            })
            .on('click', '.delete-row-btn', function(event) {
                $target = $(this).parent().parent();
                delete_page($target.attr('id'))
                .done(function(res) {
                    if (res.error) {
                        alert(res.error);
                        return;
                    } else if (res.success) {
                        $target.remove();
                    } else {
                        alert('else');
                    }
                })
                .fail(function(data, textStatus, xhr) {
                    if (data.status == 401) {
                        window.location.href = BASE_URL_LOGIN;
                    }
                    
                    alert('error');
                });
            })
        });
        
    
    </script>
{% endblock %}

